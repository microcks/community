# Securing MongoDB with Encryption

For environments requiring enhanced security, you can implement encryption for your MongoDB deployment. There are two primary types of encryption you can configure:

* Transit-Level Encryption (TLS): Secures data as it travels between Microcks and MongoDB.

* Storage-Level Encryption: Protects data stored on disk using cloud-managed encrypted storage.

The following sections provide instructions for implementing both types of encryption.

## 1. Transit-Level Encryption (TLS)

### Step 1: Install MongoDB with TLS Enabled

Create namespace:
```shell
$ kubectl create namespace microcks-external
```
Add bitnami repo:
```shell
$ helm repo add bitnami https://charts.bitnami.com/bitnami
$ helm repo update
```

Deploy MongoDB with TLS enabled:
```shell
$ helm install my-mongodb bitnami/mongodb --namespace microcks-external --set auth.enabled=true --set auth.rootPassword=microcks123 --set auth.username=admin --set auth.password=microcks123 --set auth.database=microcks-db --set tls.enabled=true --set tls.autoGenerated=true
```

### Step 2: Create MongoDB Credentials Secret

Create secret
```shell
cat << EOF > mongodb-secret.yaml
apiVersion: v1
kind: Secret
metadata:
  name: external-mongodb-connection
  namespace: microcks-external
  labels:
    app: microcks
    container: mongodb
    group: microcks
type: kubernetes.io/basic-auth
stringData:
  username: "admin"
  password: "microcks123"
EOF
```
Apply the secret:
```shell
$ kubectl apply -f mongodb-secret.yaml -n microcks-external
```

### Step 3: Deploy Microcks with TLS Connection

Add Microcks repo:
```shell
helm repo add microcks https://microcks.io/helm
helm repo update
```

Deploy Microcks configured to use TLS:
```shell
$ helm install microcks microcks/microcks --namespace microcks-external --set mongodb.install=false --set mongodb.uri=my-mongodb.microcks-external.svc.cluster.local:27017 --set mongodb.database=microcks-db --set mongodb.uriParameters="?tls=true&tlsAllowInvalidCertificates=false" --set mongodb.secretRef.secret=external-mongodb-connection --set mongodb.secretRef.usernameKey=username --set mongodb.secretRef.passwordKey=password --set microcks.url=microcks.m.minikube.local --set keycloak.url=keycloak.m.minikube.local --set keycloak.privateUrl=http:/microcks-keycloak.microcks-external.svc.cluster.local:8080
```

### TLS Verification Steps
```shell
# Check if MongoDB is running with TLS
$ kubectl get pods -n microcks-external

# Check MongoDB service
$ kubectl get svc -n microcks-external

# Verify TLS configuration
$ kubectl logs -n microcks-external $(kubectl get pod -n microcks-external -l app.kubernetes.io/name=mongodb -o jsonpath="{.items[0].metadata.name}")
```

### Important Notes for TLS

* Use proper TLS certificates in production instead of auto-generated ones.
* Ensure your client supports TLS by using the appropriate tls=true parameters in the connection string.
* Validate TLS certificates if using self-signed certs, or disable validation only in development.



## 2. Storage-Level Encryption 
For production environments, this guide provides steps to configure cloud-managed encrypted storage.

### Recommended Cloud Storage Encryption Options
* AWS: Use gp3 or gp2 EBS volumes with encryption enabled.
* Azure: Use Azure Managed Disks with encryption enabled.
* GCP: Use GCE Persistent Disks with encryption enabled.

### Deploy MongoDB with encrypted cloud storage (example for AWS EKS)
```shell
$ helm install my-mongodb bitnami/mongodb --namespace microcks-external --set auth.enabled=true --set auth.existingSecret=mongodb-secret --set auth.database=microcks-db --set tls.enabled=true --set tls.autoGenerated=true --set persistence.storageClass=gp3 --set persistence.size=8Gi
  ```
âš  Ensure encryption is enabled at the cloud provider level when provisioning storage volumes.
Storage Encryption Verification Steps
For cloud providers, you can check encryption status via the cloud console or CLI:

* AWS: `aws ec2 describe-volumes --filters Name=encrypted,Values=true`
* Azure: `az disk show --name <disk-name> --query "encryptionSettings"`
* GCP: `gcloud compute disks describe <disk-name> --format="value(diskEncryptionKey)"`

### Important Notes for Storage Encryption

* Enable encryption at the cloud provider level when creating storage volumes.
* Use customer-managed encryption keys (CMEK) where available for greater security control.
* Monitor and audit storage encryption status regularly using cloud security tools.